テストの費用対効果
==================

コンテクスト
------------

テストコードを書こうとしている。

問題
----

テストの実行時間が長くなり、開発者のストレスとなったり、問題の発見が遅れたりする。

問題の原因
----------

Railsにはテストコーディングを補助するヘルパーメソッドが用意されていたり、雛形コードのジェネレータによって製品コードと共にテストコードの雛形も生成されるなど、テストコードを書きやすくする仕組みが備わっている。
このように、Railsアプリケーションにおいてテストコードを書くことは推奨されているが、個々のテストケースの価値やテスト実行のコストについてはRails Guidesでも言及されておらず、Rails初心者が実際に問題に遭遇するまでテスト実行時間について検討する機会が提供されていない。

フォース
--------

* 円滑な開発や問題の早期発見のために、テストコードを書くことは望ましい。
* 全く実行時間のかからないテストコードは存在しない。

解決方法
--------

費用対効果を考慮しながらテストコードを書く。

例
--

#### 1. インテグレーションテスト

Railsがサポートするテストのうち、ブラウザをエミュレートし、JavaScriptの実行からデータベースアクセスまで全てのレイヤを実行するインテグレーションテストは最も実行時間がかかるため、全ての条件分岐を網羅するテストをインテグレーションテストで書くと、他の種類のテストで書いた場合よりも実行時間が長くなってしまう。
インテグレーションテストは、全レイヤを実行しレイヤ間の接続を確認できることを活かし、スモークテストに利用するとよい。

#### 2. ビジネス上の価値の反映

テストケースの価値は、テスト対象のビジネス上の価値に依存する。
例えば、ビジネスの成立に必須ではない代替手段のある機能は、カバー率を上げて実行時間をかける価値は低い。
逆に、ビジネスの成立に不可欠な機能のカバー率を上げるべきである。

#### 3. モックとスタブの利用

どのレイヤのテストを書く場合でも、テスト対象を明確にし、対象外のコードを実行しないことで実行時間を最短にできる。
実行するコードを最小にするためには、モックやスタブの利用を検討する。

例えば、ルーティングをテストするコードでデータベースにアクセスしてはいけない。
永続化層はスタブにし、実際の入出力処理の実行を回避すべきである。


結果
----

アプリケーションを拡張してもテストの実行時間は適切な範囲に保たれる。
リグレッションは早期に発見され、開発者は安心して開発を進められる。
