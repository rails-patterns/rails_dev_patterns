コードの収まり
========

コンテクスト
------------

ビジネスロジックを書こうとしている。

問題
----

モデル層とコントローラ層のクラスが肥大化し、改修や保守が困難になる。

問題の原因
----------

Railsにはコードの雛形を生成する機能が備わっており、その機能を使うとモデルとコントローラ、ビューの各層のファイルができる。
ビュー層のファイルはHTMLテンプレートなので、ビジネスロジックを書くには適さない。
逆に、全てのビジネスロジックは生成されたモデルとコントローラに書いて実現できる。
実際に、David Heinemeier Hanssonが著者として参加している入門書Agile Web Development with Rails 4[11]でもモデルとコントローラにコードを書いている。

ところが、現実のソフトウェアはより複雑な場合があり、アプリケーションによって適切なアーキテクチャは異なり、モデルとコントローラに書くことが最適とは限らない。

フォース
--------

* 機能の拡張や改修を繰り返すことでコードは増加する。
* 世の中の全てのアーキテクチャをサポートすることはできない。

解決方法
--------

モデルとコントローラの責務を明確にし、その範囲を越える処理は、より適切なクラスやレイヤに割り当てる。

例
--

#### 1. サービスレイヤ

例えば、複数のモデル（仮にAとBとする）が関与する処理について考える。
この処理はAの責務ともBの責務とも言い切れない場合がある。
Aの責務としてAからBを参照すれば、AとBが密結合し、保守性が低下するし、逆もまた同様である。
だからといって、この処理をコントローラ層に置くと、コントローラ層が肥大化する。
このように、複数のモデルが関わる処理はサービスと呼ばれるレイヤに切り出す解決方法がある([*1](#user-content-ddd))。

#### 2. ActiveSupport::Concern

Rails 4.0ではモデルまたはコントローラクラスの機能の一部をモジュールに切り出す仕組みである[ActiveSupport::Concern](http://api.rubyonrails.org/v4.0.0/classes/ActiveSupport/Concern.html)と、専用のディレクトリが導入された。
ActiveSupport::Concernを使うことで、モデルまたはコントローラ本来の責務ではない処理や、複数のクラスに共通する処理を独立したモジュールに書ける。

#### 3. Single Responsibility Principle

Single Responsibility Principle（以下SRP）はオブジェク指向プログラミングの原則であり、一つのクラスが一つの責務を持つことを表す。
SRPの侵害はモデルやコントローラの肥大化の原因の一つである。
特に、SRPに則ったモデルのリファクタリング方法については、[Bryan HelmkampがRubyKaigi 2013で発表](http://rubykaigi.org/2013/talk/S32)している。

結果
----

アプリケーションの拡張が続いてもクラスの責務は明確で読みやすい。コードは継続的な保守に耐える。

- - -

<a id="ddd">*1</a>: エリック・エヴァンス. 2011. [エリック・エヴァンスのドメイン駆動設計](http://www.amazon.co.jp/dp/B00GRKD6XU). 翔泳社.
